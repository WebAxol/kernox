var e={d:(t,s)=>{for(var i in s)e.o(s,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:s[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};e.d(t,{mx:()=>_,wE:()=>u,iQ:()=>h});class s{constructor(e){this.__kernox=e,this.__namespaces=new Set}use(e){const{name:t}=e;if(this.namespaces.has(t))throw new Error(`Conflict with already existing namespace '${t}', please consider renaming one of them.`);e.collections&&this.registerCollections(e.collections,t),e.prototypes&&this.registerPrototypes(e.prototypes,t),e.systems&&this.registerSystems(e.systems,t),this.namespaces.add(t)}get namespaces(){return this.__namespaces}registerPrototypes(e,t){e.forEach((e=>{this.__kernox.entityFactory.prototype(e,t)}))}registerCollections(e,t){e.forEach((e=>{this.__kernox.collectionManager.use(e,t)}))}registerSystems(e,t){e.forEach((e=>{this.__kernox.systemManager.use(e,t)}))}}class i{}function r(e,t){let s=e.prototype;for(;s;)if(s=Object.getPrototypeOf(s),s===t.prototype)return!0;return!1}class n{constructor(e){this.__kernox=e,this.collections=new Map,this.toRemove=new Set}get(e){const t=this.collections.get(e)||this.resolveImplicitNamespace(e);if(!t)throw new Error(`Collection '${e}' is not registered.`);return t}use(e,t=""){if(!r(e,i))throw new Error("Invalid collection: it must be a sub-class of AbstractCollection");const s=t?`${t}.${e.name}`:e.name;if(this.collections.has(s))throw new Error(`Cannot register collection '${s}' because it already exists`);const n=new e;this.collections.set(s,n)}addEntityTo(e,t){this.get(t).insert(e),e.linkTo(t)}removeEntityFrom(e,t){this.get(t).remove(e),e.unlinkFrom(t)}remindToForget(e){this.toRemove.add(e)}flushRemoved(){for(const e of this.toRemove)for(const t of e.collections())this.removeEntityFrom(e,t);this.toRemove.clear()}resolveImplicitNamespace(e){const t=this.__kernox.addonLoader.namespaces;var s,i;for(const r of t)if((i=this.collections.get(`${r}.${e}`))&&!s)s=i;else if(i)throw new Error(`Ambiguous collection '${e}' was requested: a namespace must be specified before it ( Ex. namespace.collectionName ).`);return s}}class o{constructor(e,t){this.__ID=e,this.__TYPE=t,this.__children={},this.__collections=new Set,this.__modified=!1}get id(){return this.__ID}get type(){return this.__TYPE}belongsTo(e){return this.__collections.has(e)}collections(){return this.__collections}linkTo(e){this.__collections.add(e)}unlinkFrom(e){this.__collections.delete(e)}appendChild(e,t){if(this.__children[e])throw Error(`Child already exists with name '${e}' at entity '${this.__ID}'`);this.__children[e]=t}getChild(e){return this.__children[e]}deleteChild(e){delete this.__children[e]}}class a{constructor(e){this.__kernox=e,this.types=new Map,this.pools=new Map,this.nextID=0}prototype(e,t=""){const s=t?`${t}.${e.name}`:e.name;if(this.types.has(s))throw Error(`The type named '${s}' has already been registered`);const{inherits:i}=e;if(i){const t=i,s=[];for(const e of t)s.push(e);let r=s.pop();for(;r;){const t={};this.deepAssign(t,r.attributes),this.deepAssign(t,e.attributes),e.attributes=t,e.collections=new Set([...e.collections||[],...r.collections||[]]);for(const e of r.inherits||[])s.push(e);r=s.pop()}}this.types.set(s,e)}create(e,t={}){const s=this.types.get(e)||this.resolveImplicitNamespace(e);if(!s)throw Error(`Cannot create entity of null type '${e}'`);const i=new o(""+this.nextID++,e);this.deepAssign(i,s.attributes);for(const e of Object.keys(t))e in i&&!e.includes("_")&&(i[e]=t[e]);const r=e.split("."),n=2==r.length?r[0]:void 0;for(let e of s.collections||[])n&&(e=`${n}.${e}`),this.__kernox.collectionManager.addEntityTo(i,e),i.linkTo(e);return i}copyFromPrototype(e,t){this.deepAssign(e,t.attributes)}sendToRest(e){}resolveImplicitNamespace(e){const t=this.__kernox.addonLoader.namespaces;var s,i;for(const r of t)if((i=this.types.get(`${r}.${e}`))&&!s)s=i;else if(i)throw new Error(`Ambiguous entity type '${e}' was requested: a namespace must be specified before it ( Ex. namespace.type ).`);return s}deepAssign(e,t,s=new WeakMap){if(!s.has(t)){s.set(t,e);for(const i of Object.keys(t)){const r=t[i];null===r||"object"!=typeof r?e[i]=r:Array.isArray(r)?(e[i]=[],this.deepAssign(e[i],r,s)):r.constructor!==Object?(e[i]=new r.constructor,this.deepAssign(e[i],r,s)):(e[i]={},this.deepAssign(e[i],r,s))}}}}class c{constructor(e){this.__kernox=e,this.listeners=new Map}dispatch(e,t){const s=this.listeners[e]||this.resolveImplicitNamespace(e);if(!s)return!1;for(const e of s)e(t);return!0}attachToEvent(e,t){if(!e||"string"!=typeof e)throw new Error("[EventManager] invalid event name provided: it must be a non-empty string");if("function"!=typeof t)throw new Error("Expected function as 'handler'");return this.listeners[e]||(this.listeners[e]=new Set),this.listeners[e].add(t)}resolveImplicitNamespace(e){const t=this.__kernox.addonLoader.namespaces;var s,i;for(const r of t)if((i=this.listeners[`${r}.${e}`])&&!s)s=i;else if(i)throw new Error(`Ambiguous event '${e}' was requested: a namespace must be specified before it ( Ex. namespace.eventName ).`);return s}}class h{constructor(e,t){this.__kernox=e,this.__context=t,this.__paused=!1}init(){}execute(){}get context(){return this.__context}get paused(){return this.__paused}set paused(e){this.__paused=e}attachToEvent(e,t){const s=this.resolveResourceName(e);return this.__kernox.eventBroker.attachToEvent(s,t)}dispatchEvent(e,t){this.__kernox.eventBroker.dispatch(e,t)}getCollection(e){const t=this.resolveResourceName(e),s=this.__kernox.collectionManager.get(t);if(!s)throw Error(`Collection '${t}' was not found`);return s}resolveResourceName(e){const t=e.split(".");var s=this.context,i=e;2==t.length&&([s,i]=t);return s?`${s}.${i}`:e}}class l{constructor(e){this.__kernox=e,this.systems=new Map,this.executionList=[]}execute(){this.executionList.forEach((e=>{e.paused||e.execute()}))}use(e,t=""){const s=t?`${t}.${e.name}`:e.name;if(!r(e,h))throw new Error("Expected instance of 'System'");if(this.systems.has(s))return console.warn(`System '${s}' is already registered`),!1;const i=new e(this.__kernox,t);return i.init(),this.systems.set(s,i),this.executionList.push(i),!0}unuse(e){const t=this.systems.get(e);t&&(this.systems.delete(e),this.executionList=this.executionList.filter((e=>e!==t)))}get(e){return this.systems.get(e)}}class _ extends i{constructor(){super(...arguments),this.entities=[],this.ids=new Set,this.__changed=!1}insert(e){return!this.has(e)&&(this.entities.push(e),e.linkTo(this.constructor.name),this.__changed=!0,!0)}remove(e){const t=this.entities.indexOf(e);return-1!=t&&(this.ids.delete(e.id),this.entities.splice(t,1),e.unlinkFrom(this.constructor.name),this.__changed=!0,!0)}has(e){return-1!=this.entities.indexOf(e)}*[Symbol.iterator](){yield*this.entities}sort(e){this.entities.sort(e)}filter(e){return this.entities.filter(e)}asArray(){return Array.from(this.entities)}get(e){return this.entities[e]}size(){return this.entities.length}get changed(){return this.__changed}}class u{constructor(){this.__entityFactory=new a(this),this.__collectionManager=new n(this),this.__systemManager=new l(this),this.__eventBroker=new c(this),this.__addonLoader=new s(this),this.__paused=!1,this.__started=!1,this.__frame=0,this.__lastTime=0,this.__dt=1,this.__fps=0}execute(e=30){try{if(this.__started||(this.__started=!0,this.__eventBroker.dispatch("__start")),this.paused)return;this.__dt=e-this.__lastTime,this.__fps=1e3/this.dt,this.__lastTime=e,requestAnimationFrame((e=>this.execute(e))),this.__systemManager.execute(),this.__frame++}catch(e){console.error(e),console.warn("A run-time error has occurred, execution was paused"),this.__paused=!0}}use(e){this.__addonLoader.use(e)}get entityFactory(){return this.__entityFactory}get collectionManager(){return this.__collectionManager}get systemManager(){return this.__systemManager}get eventBroker(){return this.__eventBroker}get addonLoader(){return this.__addonLoader}get started(){return this.__started}get frame(){return this.__frame}get paused(){return this.__paused}get dt(){return this.__dt}get fps(){return this.__fps}}var d=t.mx,p=t.wE,m=t.iQ;export{d as ArrayList,p as Kernox,m as System};